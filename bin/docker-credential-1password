#!/usr/bin/env bash

set -euo pipefail

if [[ "${1:-}" != 'get' ]]; then
    echo "Unsupported command '${1:-}' by 1Password credential helper." >&2
    exit 1
fi

registry="$(cat)"

case "${registry}" in
    docker.io)
        item_name='docker.com'
        item_fields='username,password'
        ;;
    *)
        echo "Unsupported registry '${registry}' by 1Password credential helper." >&2
        exit 1
        ;;
esac

item="$(systemd-run --user --quiet --pipe --pty --collect -- op item get "${item_name}" --reveal --fields "${item_fields}" || exit 2)"
IFS="," read username password <<< "${item}"

cat <<EOF
{
    "ServerURL": "${registry}",
    "Username": "${username}",
    "Secret": "${password}"
}
EOF
